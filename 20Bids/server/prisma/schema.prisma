generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   // Hashed password
  name      String?
  avatarUrl String?
  settings  Json?
  createdAt DateTime @default(now())
  tags      Tag[]
  watchlist Watchlist[]
}

model Recommendation {
  id            String   @id @default(uuid())
  symbol        String
  name          String
  date          DateTime
  price         Float     // Real-time/closing price
  open          Float     @default(0) // Opening price
  high          Float     @default(0) // High price
  refPrice1020  Float?    // Reference price at 10:20 AM
  lowBeforePeak Float?    // Lowest price between 10:20 and the daily High
  refPrice1120  Float?    // Reference price at 11:20 AM
  highPost1120  Float?    // Max Excursion after 11:20 AM
  refPrice1220  Float?    // Reference price at 12:20 PM
  highPost1220  Float?    // Max Excursion after 12:20 PM
  changePercent Float
  volume        Float
  relativeVol   Float
  marketCap     Float
  sector        String
  type          String
  probability   String
  probabilityValue Int @default(70)
  time          String
  stopLoss      Float
  priceTarget   Float
  thesis        String
  catalyst      String?
  rsi           Float
  beta          Float
  earningsDate  String?
  analystRating String
  sentiment     String

  // Live IBKR Sync Data (Hybrid Architecture)
  ibkrPosition      Int?     @default(0)
  ibkrAvgCost       Float?   @default(0)
  ibkrUnrealizedPNL Float?   @default(0)

  @@unique([symbol, date])
}

model Tag {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  symbol    String
  color     String
  
  @@unique([userId, symbol])
}

model Watchlist {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  symbol    String
  
  @@unique([userId, symbol])
}

// Trading automation configuration
model TradingConfig {
  id                   Int      @id @default(autoincrement())
  takeProfit           Float    @default(3.0)     // Take profit %
  stopLoss             Float    @default(5.0)     // Stop loss %
  maxStocks            Int      @default(10)      // Max stocks to trade
  minVolume            Float    @default(1000000) // Min volume filter
  minPrice             Float    @default(5.0)     // Min price filter
  maxGainSkip          Float    @default(1.0)     // Skip if already gained >X%
  prioritizeBelowRef   Boolean  @default(true)    // Prioritize stocks below refPrice1020
  retryIntervalMinutes Int      @default(1)       // Retry interval if no data
  maxRetries           Int      @default(10)      // Max retry attempts
  executionHour        Int      @default(10)      // Hour to execute (ET)
  executionMinute      Int      @default(25)      // Minute to execute (ET)
  enabled              Boolean  @default(false)   // Auto-trading enabled
  updatedAt            DateTime @updatedAt
}

// Log of executed trades
model TradeLog {
  id              String   @id @default(uuid())
  symbol          String
  quantity        Int
  entryPrice      Float
  takeProfitPrice Float
  stopLossPrice   Float
  parentOrderId   Int
  tpOrderId       Int
  slOrderId       Int
  status          String   @default("SUBMITTED") // SUBMITTED, FILLED, CANCELLED, ERROR
  errorMessage    String?
  executedAt      DateTime @default(now())
}
